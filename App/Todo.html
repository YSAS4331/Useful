<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Todo リスト</title>
    <style>
      :root { --bg:#36434d; --sbg:#2e3942; --ssbg:#323E48; --input:#1f2730; }
      html,body { background-color:var(--sbg); width:100vw; height:100vh; margin:0; font-family:Arial,sans-serif; color:white; }
      .flex { display:flex; justify-content:center; align-items:flex-start; width:100%; height:100%; padding-top:20px; box-sizing:border-box; }
      .app { background-color:var(--bg); width:80vw; max-width:900px; min-height:80vh; border-radius:15px; display:flex; gap:20px; padding:20px; box-sizing:border-box; }
      .shadow { box-shadow:6px 6px 15px 0 #00000080; }
      .card { flex:1; background-color:var(--bg); min-height:100%; border-radius:12px; padding:20px; box-sizing:border-box; display:flex; flex-direction:column; justify-content:flex-start; gap:15px; overflow-y:auto; }
      .input-wrapper { color:white; font-size:16px; position:relative; display:inline-block; width:100%; }
      .input-wrapper input { border:none; width:100%; outline:none; padding:10px 5px; background-color:var(--sbg); color:white; font-size:16px; border-radius:5px; transition:background-color 0.3s; }
      .input-wrapper input:focus { background-color:var(--bg); }
      .input-wrapper:has(input)::after { content:''; position:absolute; bottom:0; left:0; width:0; height:2px; background-color:var(--input); transition:width 0.4s ease; }
      .input-wrapper:has(input:focus)::after { width:100%;z-index:500; }
      #tooltip { position:fixed; font-size:12px; color:#aaa; display:none; pointer-events:none; background-color:var(--sbg); padding:5px; z-index:1000; border-radius:5px; }
      .md-wrapper { position:relative; width:100%; min-height:40px; }
      .md-sc,.md-input { position:absolute; inset:0 0 0 0; padding:10px 5px; border-radius:5px; box-sizing:border-box; background:var(--sbg); transition:opacity 0.18s ease, transform 0.18s ease; }
      .md-sc { pointer-events:auto; cursor:text; min-height:36px; color:#e9eef0; overflow-wrap:break-word; overflow-y:auto; max-height:150px; }
      .md-input { border:none; outline:none; background:transparent; color:white; width:100%; font-size:16px; opacity:0; transform:translateY(0); pointer-events:none; resize:none; height:100%; overflow-y:auto; }
      .md-wrapper.editing .md-input { opacity:1; pointer-events:auto; z-index:2; }
      .md-wrapper.editing .md-sc { opacity:0; pointer-events:none; z-index:1; visibility:hidden; }
      .md-wrapper:not(.editing) .md-sc { opacity:1; pointer-events:auto; z-index:1; visibility:visible; }
      .md-wrapper:not(.editing) .md-input { opacity:0; pointer-events:none; z-index:0; }
      .md-sc em { font-style:italic; color:#fff; }
      .md-sc strong { font-weight:700; color:#fff; }
      .md-sc code, pre { font-family: Consolas, Menlo, Monaco, 'Courier New', monospace; font-size: 14px;line-height: 1.5;background-color: #697580;padding: 2px 4px;border-radius: 5px;}
      .button { border:none;width:100%;padding:10px 5px;background-color:var(--sbg);color:white;font-size:16px;border-radius:5px;cursor:pointer;transition:background-color 0.3s, transform 0.3s, box-shadow 0.3s; box-shadow:0px 5px 3px #00000080;}
      .button:hover { background-color:var(--ssbg); }
      .button:active { transform: translateY(5px); box-shadow: none;}
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  </head>
  <body>
    <div class="flex">
      <div class="app shadow flex">
        <div class="shadow card">
          <label class="input-wrapper" data-title="タスク名">
            タスク名:
            <div class="md-wrapper">
              <input type="text" class="md-input" placeholder="タスク名" aria-label="タスク名">
              <div class="md-sc" aria-hidden="false"></div>
            </div>
          </label>
          <label class="input-wrapper" data-title="詳細">
            詳細:
            <div class="md-wrapper" style="min-height:120px">
              <textarea class="md-input" placeholder="詳細" aria-label="詳細" style="height:100%;"></textarea>
              <div class="md-sc" aria-hidden="false" style="overflow-y:auto; max-height:150px;"></div>
            </div>
          </label>

          <label class="input-wrapper" data-title="日付">
            日付:
            <input id="date" type="text" placeholder="日付(YYYY/MM/DD)" aria-label="日付">
          </label>

          <button class="button" data-title='追加'>追加</button>
        </div>

        <div class="shadow card">
          <label data-title="タスクリスト">タスクリスト:</label>
        </div>
      </div>
    </div>
    <span id='tooltip'></span>

    <script>
const $ = el => document.getElementById(el);
const $$$ = sel => document.querySelectorAll(sel);
const STORAGE_KEY = 'todo_app_v1';

let todos = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');

document.addEventListener("mousemove", (e) => {
  const hovered = document.elementFromPoint(e.clientX, e.clientY);
  const tooltip = $('tooltip');
  if (hovered && hovered.dataset.title) {
    tooltip.textContent = hovered.dataset.title;
    tooltip.style.left = `${e.clientX + 10}px`;
    tooltip.style.top = `${e.clientY + 10}px`;
    tooltip.style.display = 'block';
  } else {
    tooltip.style.display = 'none';
  }
});

function renderMD(text, placeholder='') {
  if (!text) return placeholder;
  const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  let t = esc(text);

  t = t.replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>');
  t = t.replace(/\*(.+?)\*/g, '<em>$1</em>');

  // ```コードブロックのみ highlight.js に対応し、@@CODEBLOCK@@に置換
  t = t.replace(/```(\w+)?\n([\s\S]*?)```/g, (match, lang, code) => {
    lang = lang || 'plaintext';
    const codeHTML = `<pre><code class="language-${lang}">${code}</code></pre>`;
    return `@@CODEBLOCK@@${btoa(codeHTML)}`;
  });

  t = t.replace(/`([^`]+)`/g, '<code>$1</code>');
  t = t.replace(/%\(([^)]*)\)(.*?)%\/\(\)/g, (match, color, content) => `<span style="color:${color}">${content}</span>`);
  t = t.replace(/\r?\n/g, '<br>');

  return t;
}

document.querySelectorAll('.md-wrapper').forEach(wrapper => {
  const input = wrapper.querySelector('.md-input');
  const sc = wrapper.querySelector('.md-sc');
  const placeholder = wrapper.parentElement.dataset.title || '';

  function updatePreview() {
    let html = renderMD(input.value, placeholder);
    html = html.replace(/@@CODEBLOCK@@([A-Za-z0-9+/=]+)/g, (_, b64) => {
      const decoded = atob(b64);
      return decoded;
    });
    sc.innerHTML = html;

    sc.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));

    const editing = wrapper.classList.contains('editing');
    sc.setAttribute('aria-hidden', editing ? 'true' : 'false');
    input.setAttribute('aria-hidden', editing ? 'false' : 'true');
  }

  wrapper.classList.remove('editing');
  updatePreview();

  sc.addEventListener('click', () => { wrapper.classList.add('editing'); setTimeout(()=> input.focus(),10); updatePreview(); });
  input.addEventListener('focus', () => { wrapper.classList.add('editing'); updatePreview(); });
  input.addEventListener('blur', () => { setTimeout(()=> { wrapper.classList.remove('editing'); updatePreview(); },0); });
  input.addEventListener('input', updatePreview);
});

$('date').addEventListener('change', () => {
  let value = $('date').value;
  if (!value) return;
  value = value.replaceAll('-', '/');
  $('date').value = value;
  const parts = value.split('/');
  const year = Number(parts[0]), month = Number(parts[1]), day = Number(parts[2]);
  const dateObj = new Date(year, month - 1, day);
  if (isNaN(year) || isNaN(month) || isNaN(day) || dateObj.getFullYear() !== year || dateObj.getMonth() + 1 !== month || dateObj.getDate() !== day) {
    alert('存在しない日付です。正しい日付を入力してください。');
    $('date').value = '';
    $('date').focus();
    return;
  }
  $('date').value = `${year}/${String(month).padStart(2,'0')}/${String(day).padStart(2,'0')}`;
});

document.querySelector('.button').addEventListener('click', () => {
  const mdWrappers = document.querySelectorAll('.md-wrapper');
  const taskName = mdWrappers[0].querySelector('.md-input').value.trim();
  const taskDetail = mdWrappers[1].querySelector('.md-input').value.trim();
  const taskDate = $('date').value.trim();

  if (!taskName) { alert('タスク名を入力してください'); return; }

  const newTodo = { name: taskName, detail: taskDetail, date: taskDate };
  todos.push(newTodo);
  localStorage.setItem(STORAGE_KEY, JSON.stringify(todos));
  alert('タスクを追加しました');

  mdWrappers.forEach(w => w.querySelector('.md-input').value = '');
  $('date').value = '';
  mdWrappers.forEach(w => w.querySelector('.md-sc').innerHTML = renderMD('', w.parentElement.dataset.title));
});

    </script>

  </body>
</html>
