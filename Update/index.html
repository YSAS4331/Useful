<!DOCTYPE html>
<html lang="ja">
  <head>
    <title>更新履歴</title>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="../assets/css/variables.css">
    <style>
      body {
        font-family: sans-serif;
        line-height: 1.6;
        max-width: 800px;
        margin: 2em auto;
        padding: 0 1em;
        background-color: var(--bg);
        color: var(--text);
      }
      h1, h2 {
        border-bottom: 1px solid #ccc;
        padding-bottom: 0.3em;
      }
      .update {
        border: 2px solid rgba(255,255,255,0.02);
        border-radius: 5px;
        padding: 5px;
        background-color: var(--chip-bg);
      }
      #updates {
        display: flex;
        flex-direction: column;
        gap: 5px;
      }
    </style>
  </head>
  <body>
    <h1>更新履歴</h1>
    <div id="updates"></div>
    <script>
      (async () => {
        const params = new URLSearchParams(window.location.search);
        const app = params.get('app');
        const box = document.getElementById('updates');
        if (!app) return;

        box.textContent = '読み込み中...';

        try {
          const response = await fetch('https://ysas4331.github.io/Useful/Update/updates.json');
          if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

          const updates = await response.json();
          const data = updates[app];
          if (!data) {
            box.textContent = '指定されたアプリの更新履歴は見つかりません。';
            return;
          }

          // 更新データを新しい順にソート（date降順）
          const sortedUpdates = [...data.updates].sort(
            (a, b) => new Date(b.date) - new Date(a.date)
          );

          // URLの n パラメータを取得（例: ?app=test&n=2）
          const numberParam = params.get('n');
          const number = numberParam ? parseInt(numberParam, 10) : null;

          // コンテンツを初期化
          box.textContent = '';

          // 各更新情報を追加
          sortedUpdates.forEach((update, i) => {
            const div = document.createElement('div');
            div.classList.add('update');
            div.dataset.number = i + 1;

            const head = document.createElement('div');
            head.classList.add('update-header');
            head.innerHTML = `<strong>バージョン:</strong> ${update.version}　|　<strong>日付:</strong> <time datetime="${update.date}">${update.date}</time>`;
            div.appendChild(head);

            const list = document.createElement('ul');
            update.changes.forEach(change => {
              const li = document.createElement('li');
              li.textContent = change;
              list.appendChild(li);
            });
            div.appendChild(list);

            // nパラメータが指定されている場合、その番号だけを表示
            if (number !== null && number === i + 1) {
              box.appendChild(div);
              return;
            }

            // nパラメータがない場合はすべて表示
            if (number === null) {
              box.appendChild(div);
            }
          });

        } catch (e) {
          console.error('取得に失敗しました', e);
          box.textContent = '更新履歴の取得に失敗しました。';
        }
      })();
    </script>
  </body>
</html>
